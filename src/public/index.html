<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Logger</title>
    <!-- Import Tailwind CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <!-- Import React and ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Import Babel for JSX support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.15/babel.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        // Create React components
        const { useState, useEffect, useRef, useCallback } = React;

        // Connection Status Component
        const ConnectionStatus = ({ isConnected }) => (
            <div className="flex items-center">
                <div className={`w-2.5 h-2.5 rounded-full mr-2 ${isConnected ? 'bg-green-500' : 'bg-red-500'}`}></div>
                <span>{isConnected ? 'Connected' : 'Disconnected'}</span>
            </div>
        );

        // Header Component
        const Header = ({ isConnected }) => (
            <header className="bg-gray-800 text-white p-4 shadow-md flex justify-between items-center mb-5">
                <h1 className="text-xl font-semibold">MCP Logger</h1>
                <ConnectionStatus isConnected={isConnected} />
            </header>
        );

        // Search Component
        const SearchBox = ({ searchTerm, setSearchTerm }) => (
            <div className="relative flex-grow">
                <input 
                    type="text" 
                    className="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Search logs..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                />
                <span className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">üîç</span>
            </div>
        );

        // Filter Component
        const LevelFilters = ({ filters, toggleFilter }) => (
            <div className="flex items-center space-x-3">
                {Object.keys(filters).map(level => (
                    <div key={level} className="flex items-center">
                        <input
                            type="checkbox"
                            id={`filter-${level}`}
                            checked={filters[level]}
                            onChange={() => toggleFilter(level)}
                            className="mr-1"
                        />
                        <label htmlFor={`filter-${level}`} className="text-sm">
                            {level.charAt(0).toUpperCase() + level.slice(1)}
                        </label>
                    </div>
                ))}
            </div>
        );

        // Controls Component
        const Controls = ({ searchTerm, setSearchTerm, filters, toggleFilter, isPaused, togglePause, clearLogs }) => (
            <div className="flex items-center space-x-4 mb-4">
                <SearchBox searchTerm={searchTerm} setSearchTerm={setSearchTerm} />
                
                <LevelFilters filters={filters} toggleFilter={toggleFilter} />
                
                <button 
                    onClick={togglePause}
                    className="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-200"
                >
                    {isPaused ? 'Resume' : 'Pause'}
                </button>
                
                <button 
                    onClick={clearLogs}
                    className="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition duration-200"
                >
                    Clear
                </button>
            </div>
        );

        // Log Entry Component
        const LogEntry = ({ log }) => {
            const levelColorClass = {
                info: 'border-blue-500',
                warn: 'border-yellow-500 bg-yellow-50',
                error: 'border-red-500 bg-red-50',
                debug: 'border-gray-500 text-gray-600'
            };

            const levelBadgeClass = {
                info: 'bg-blue-500',
                warn: 'bg-yellow-500',
                error: 'bg-red-500',
                debug: 'bg-gray-500'
            };

            return (
                <div className={`p-3 border-l-4 ${levelColorClass[log.level]} border-b border-gray-200 font-mono text-sm break-words`}>
                    <span className="text-gray-500 text-xs mr-2">
                        {new Date(log.timestamp).toLocaleTimeString()}
                    </span>
                    
                    <span className={`inline-block px-1.5 py-0.5 rounded text-xs text-white mr-2 ${levelBadgeClass[log.level]}`}>
                        {log.level.toUpperCase()}
                    </span>
                    
                    <span className="mr-2">{log.message}</span>
                    
                    {log.data && (
                        <pre className="mt-1 p-2 bg-gray-100 rounded overflow-x-auto">
                            {typeof log.data === 'object' 
                                ? JSON.stringify(log.data, null, 2)
                                : log.data}
                        </pre>
                    )}
                </div>
            );
        };

        // Log Container Component
        const LogContainer = ({ logs }) => {
            const containerRef = useRef(null);
            
            useEffect(() => {
                if (containerRef.current) {
                    containerRef.current.scrollTop = containerRef.current.scrollHeight;
                }
            }, [logs]);
            
            return (
                <div 
                    ref={containerRef}
                    className="h-[calc(100vh-180px)] overflow-y-auto bg-white rounded shadow"
                >
                    {logs.map((log, index) => (
                        <LogEntry key={index} log={log} />
                    ))}
                    {logs.length === 0 && (
                        <div className="p-4 text-center text-gray-500">No logs to display</div>
                    )}
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [isConnected, setIsConnected] = useState(false);
            const [logs, setLogs] = useState([]);
            const [allLogs, setAllLogs] = useState([]);
            const [isPaused, setIsPaused] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [filters, setFilters] = useState({
                info: true,
                warn: true,
                error: true,
                debug: true
            });
            
            const wsRef = useRef(null);
            
            // WebSocket connection setup
            useEffect(() => {
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsHost = window.location.hostname || 'localhost';
                const wsPort = new URLSearchParams(window.location.search).get('port') || '8080';
                const wsUrl = `${wsProtocol}//${wsHost}:${wsPort}`;
                
                const connect = () => {
                    wsRef.current = new WebSocket(wsUrl);
                    
                    wsRef.current.onopen = () => {
                        setIsConnected(true);
                    };
                    
                    wsRef.current.onclose = () => {
                        setIsConnected(false);
                        // Try to reconnect after 5 seconds
                        setTimeout(connect, 5000);
                    };
                    
                    wsRef.current.onerror = (error) => {
                        console.error('WebSocket error:', error);
                    };
                    
                    wsRef.current.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'history') {
                            setAllLogs(data.messages);
                        } else if (data.type === 'message') {
                            setAllLogs(prev => [...prev, data.message]);
                        }
                    };
                };
                
                connect();
                
                // Cleanup on unmount
                return () => {
                    if (wsRef.current) {
                        wsRef.current.close();
                    }
                };
            }, []);
            
            // Filter logs whenever filters, search term or all logs change
            useEffect(() => {
                if (isPaused) return;
                
                const filteredLogs = allLogs.filter(log => {
                    // Apply level filter
                    if (!filters[log.level]) return false;
                    
                    // Apply search filter if search term exists
                    if (searchTerm) {
                        const messageText = log.message.toLowerCase();
                        const dataText = log.data ? JSON.stringify(log.data).toLowerCase() : '';
                        return messageText.includes(searchTerm.toLowerCase()) || 
                               dataText.includes(searchTerm.toLowerCase());
                    }
                    
                    return true;
                });
                
                setLogs(filteredLogs);
            }, [allLogs, filters, searchTerm, isPaused]);
            
            const toggleFilter = (level) => {
                setFilters(prev => ({
                    ...prev,
                    [level]: !prev[level]
                }));
            };
            
            const togglePause = () => {
                setIsPaused(!isPaused);
            };
            
            const clearLogs = () => {
                setAllLogs([]);
                setLogs([]);
            };
            
            return (
                <div className="min-h-screen">
                    <Header isConnected={isConnected} />
                    
                    <div className="container mx-auto px-4">
                        <Controls 
                            searchTerm={searchTerm}
                            setSearchTerm={setSearchTerm}
                            filters={filters}
                            toggleFilter={toggleFilter}
                            isPaused={isPaused}
                            togglePause={togglePause}
                            clearLogs={clearLogs}
                        />
                        
                        <LogContainer logs={logs} />
                    </div>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>